# Linux

- [Linux](#linux)
  - [圧縮解凍(tar, gunzip)](#圧縮解凍tar-gunzip)
    - [解凍](#解凍)
      - [tar.gz解凍](#targz解凍)
      - [tar解凍](#tar解凍)
      - [gz解凍](#gz解凍)
    - [圧縮](#圧縮)
      - [tar.gz圧縮](#targz圧縮)
      - [tar圧縮](#tar圧縮)
      - [gz圧縮](#gz圧縮)
  - [別名の設定(aliasコマンド)](#別名の設定aliasコマンド)
  - [フォルダのサイズを確認する(duコマンド)](#フォルダのサイズを確認するduコマンド)
  - [フォルダの空き容量を表示する(dfコマンド)](#フォルダの空き容量を表示するdfコマンド)
  - [文字列を編集する(sedコマンド)](#文字列を編集するsedコマンド)
    - [先頭に追記する](#先頭に追記する)
    - [指定した個所を別のファイルの内容に置換する](#指定した個所を別のファイルの内容に置換する)
  - [scpコマンド](#scpコマンド)
    - [scp 参考](#scp-参考)
  - [ファイル名にDateを使う](#ファイル名にdateを使う)
  - [freeコマンド](#freeコマンド)
    - [参考](#参考)
  - [シンボリックリンク(lnコマンド)](#シンボリックリンクlnコマンド)
  - [grep](#grep)
    - [IPアドレスを抽出する](#ipアドレスを抽出する)
      - [参考](#参考-1)
    - [特定のファイルを除外する](#特定のファイルを除外する)
      - [参考](#参考-2)
    - [権限がないエラーを出力させない](#権限がないエラーを出力させない)
    - [ファイル名のみ出力する](#ファイル名のみ出力する)
    - [バイナリファイルを無視する](#バイナリファイルを無視する)
      - [オプション一覧](#オプション一覧)
      - [参考](#参考-3)
  - [バイナリファイルかどうか確認する(fileコマンド)](#バイナリファイルかどうか確認するfileコマンド)
  - [文字コードを変換する(iconv)](#文字コードを変換するiconv)
    - [参考](#参考-4)
  - [xargs](#xargs)
    - [パイプで受け取ったファイルパスの出力位置を任意で修正する](#パイプで受け取ったファイルパスの出力位置を任意で修正する)
  - [サービスの登録(systemd)(Ubuntu)](#サービスの登録systemdubuntu)
    - [登録方法](#登録方法)
    - [起動/停止/ステータス確認](#起動停止ステータス確認)
    - [参考](#参考-5)
  - [CPU,メモリの監視をログに出力する(vmstat, tee)](#cpuメモリの監視をログに出力するvmstat-tee)
    - [参考](#参考-6)
  - [標準出力/エラー出力を捨てる](#標準出力エラー出力を捨てる)
    - [参考](#参考-7)
  - [ログローテート](#ログローテート)
  - [ダミーファイルを作成する(ddコマンド)](#ダミーファイルを作成するddコマンド)
    - [参考](#参考-8)
  - [cat json - jq - lessを色付きにする](#cat-json---jq---lessを色付きにする)
  - [改行コード確認](#改行コード確認)
  - [改行コード変換](#改行コード変換)
  - [tab -\> スペース変換(expand)](#tab---スペース変換expand)
  - [diff](#diff)
    - [差分の行数を取得する](#差分の行数を取得する)
    - [標準出力の結果の差分を取得する](#標準出力の結果の差分を取得する)
    - [タブ・スペース・開業の違いを無視する](#タブスペース開業の違いを無視する)
      - [参考](#参考-9)
  - [ファイルの行数を取得する(wc)](#ファイルの行数を取得するwc)
  - [重複排除](#重複排除)
  - [sshポートフォワーディング](#sshポートフォワーディング)
  - [GUIとCUIを切り替える](#guiとcuiを切り替える)
    - [CUIにする](#cuiにする)
      - [一時的な変更](#一時的な変更)
      - [永続的な変更](#永続的な変更)
      - [ログイン](#ログイン)
    - [GUIにする](#guiにする)
      - [一時的な変更](#一時的な変更-1)
      - [永続的な変更](#永続的な変更-1)
  - [リモートデスクトップサービス](#リモートデスクトップサービス)
    - [インストール](#インストール)
    - [起動設定](#起動設定)
  - [起動時に何らかのサービスを起動する](#起動時に何らかのサービスを起動する)
  - [ストレージのチェックと修復](#ストレージのチェックと修復)
    - [参考](#参考-10)

## 圧縮解凍(tar, gunzip)

### 解凍

#### tar.gz解凍

``` sh
tar zxvf ${対象ファイル}.tar.gz
```

#### tar解凍

``` sh
tar xvf ${対象ファイル}.tar
```

#### gz解凍

``` sh
gunzip -k ${対象ファイル}.gz
```

または

``` sh
gzip -d ${対象ファイル}.gz
```

### 圧縮

#### tar.gz圧縮

``` sh
tar zcvf ${対象ファイル}.tar.gz ${対象ディレクトリ}
```

#### tar圧縮

``` sh
tar cvf ${対象ファイル}.tar ${対象ディレクトリ}
```

#### gz圧縮

```sh
gzip -r ${対象ディレクトリ}
```

## 別名の設定(aliasコマンド)

```${HOME}/.bashrc```にでも書いておくといいんでね？

``` bash
alias 別名=元のコマンド
# スペースを含む場合はダブルクォーテーションで囲む。
```

## フォルダのサイズを確認する(duコマンド)

```sh
du -ms <パス> | sort -nr
```

- \-m
  - MB単位表示
- \-s
  - 総計を表示

## フォルダの空き容量を表示する(dfコマンド)

``` sh
df -hT /dev/xvda1
```

## 文字列を編集する(sedコマンド)

### 先頭に追記する

``` sh
sed -i '1i${記載したい文字列}' ${ファイルパス}

# まとめて書く
sed -i '1i${記載したい文字列}' *.sql
```

### 指定した個所を別のファイルの内容に置換する

``` sh
$ cat file1 
# この下を何かに置換したい
${basicauth}
``` 

``` sh
$ cat basicauth 
    hoge
    piyo
    fuga
```

``` sh
# 問題のコマンド
$ sed -e '/${basicauth}/r basicauth' file1 -e '/${basicauth}/d'
# この下を何かに置換したい
    hoge
    piyo
    fuga
```

## scpコマンド

```
scp <ローカルパス> <ユーザ名>@<接続先ホスト>:<コピー先パス>
```
### scp 参考

[Qiita:scpコマンド](https://qiita.com/chihiro/items/142ebe6980a498b5d4a7)

## ファイル名にDateを使う

```
cp -p <ファイル名> <ファイル名>`date "+%Y%m%d_%H%M%S"`.<拡張子>
```

## freeコマンド
メモリの調査を行う

|オプション|効果|
|:---|:---|
|-s <数字>|<数字>秒ごとに表示|
|-b, -k, -m|xxxバイト単位で表示|
|-t|物理メモリ、スワップメモリの合計を表示|

実行例
```sh
$ free -s 5 -mt
              total        used        free      shared  buff/cache   available
Mem:           3933         508        2114         251        1309        2995
Swap:             0           0           0
Total:         3933         508        2114

              total        used        free      shared  buff/cache   available
Mem:           3933         508        2114         251        1309        2995
Swap:             0           0           0
Total:         3933         508        2114

              total        used        free      shared  buff/cache   available
Mem:           3933         508        2114         251        1309        2995
Swap:             0           0           0
Total:         3933         508        2114
```

### 参考

- [Qiita:Linux負荷監視コマンドまとめ](https://qiita.com/aosho235/items/c4d6995743dd1dac16e1)

## シンボリックリンク(lnコマンド)

シンボリックリンクを貼る
```sh
ln -s <リンク先パス> <入口>
```

シンボリックリンクを削除する
```sh
unlink <入口>
```

## grep

### IPアドレスを抽出する

厳密にはIPではないが…
```
grep -rE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' .
```

#### 参考

- [conf t:grepでIPアドレスを抽出する](https://monaski.hatenablog.com/entry/2015/12/14/173753)

### 特定のファイルを除外する

```
--exclude=<ファイル名>
```

#### 参考

- [Linuxエンジニアの備忘Log:特定のファイルやディレクトリをgrep結果から除却](http://www.sooota.com/%E7%89%B9%E5%AE%9A%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%84%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E3%82%92grep%E7%B5%90%E6%9E%9C%E3%81%8B%E3%82%89%E9%99%A4%E5%8D%B4/)

### 権限がないエラーを出力させない

``` sh
grep ${検索条件} 2> /dev/null
```

### ファイル名のみ出力する

``` sh
grep -ril ${検索条件} 
```

### バイナリファイルを無視する

```
--binary-files=without-match
```


#### オプション一覧

| オプション | 効果 |
| :--      | :--- |
| binaly | 「一致しました」と表示 |
| text | バイナリの中身を表示 |
| without-match | 無視する |

#### 参考

- [揮発性のメモ２:grepでバイナリファイルを無視する](https://iww.hateblo.jp/entry/20150724/binary_files_without_match)

## バイナリファイルかどうか確認する(fileコマンド)

```
file --mime <対象ファイル>
```

## 文字コードを変換する(iconv)

実行例：Shift-JISからUTF-8に変換する。

``` sh
iconv --f sjis -t utf8 ${変換対象ファイル}
```

### 参考

- [atmarkit:【 iconv 】コマンド――文字コードを変換する](https://www.atmarkit.co.jp/ait/articles/1609/12/news019.html)

## xargs

### パイプで受け取ったファイルパスの出力位置を任意で修正する

``` sh
find . -type f | xargs -I{} bash -c "iconv --f sjis -t utf8 {} > iconv_utf8_{}
```

## サービスの登録(systemd)(Ubuntu)

### 登録方法

1. /usr/lib/systemd/system配下に*.serviceのファイル名でファイル作成
2. 作成したファイルの中身を記載する。
3. ```sudo systemctl enable <サービス>.service```

[Install]が書いてあればシンボリックリンクは勝手に貼ってくれるはず。```/etc/systemd/system```配下のディレクトリに作成される。

### 起動/停止/ステータス確認

起動

``` sh
systemctl start <サービス名>
```

停止

``` sh
systemctl stop <サービス名>
```

ステータス

``` sh
systemctl status <サービス名>
```

### 参考

- [YUUKO's経験値:Ubuntu環境で自分で作ったサービスをシステムに登録する方法](https://yuukou-exp.plus/ubuntu-register-my-service-to-system/)
- [cles::blog:CentOS 7 で自分でビルドした apache を使うと systemctl start が戻ってこない](https://blog.cles.jp/item/9413)
- [Github:SampleUser0001:Transfer_service_memlog](https://github.com/SampleUser0001/Transfer_service_memlog)

## CPU,メモリの監視をログに出力する(vmstat, tee)

``` sh
vmstat -tn {出力間隔(秒)} | tee {ログファイル名} 
```

出力例

``` txt
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- -----timestamp-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st                 JST
 0  1      0 4356844  32664 1148536    0    0    54     1   15   79  0  0 99  0  0 2021-03-04 09:15:13
 0  0      0 4358884  32664 1148536    0    0    28     0   66  432  0  0 99  0  0 2021-03-04 09:15:14
 0  0      0 4358884  32664 1148536    0    0     0     0   61  407  0  0 100  0  0 2021-03-04 09:15:15
 0  0      0 4358884  32664 1148536    0    0     0     0   46  361  0  0 100  0  0 2021-03-04 09:15:16
 0  0      0 4358884  32664 1148536    0    0     0     0   47  366  0  0 100  0  0 2021-03-04 09:15:17
 0  0      0 4358884  32664 1148536    0    0     0     0   54  386  0  0 100  0  0 2021-03-04 09:15:18
 0  0      0 4358884  32672 1148528    0    0     0    32   66  427  0  0 99  1  0 2021-03-04 09:15:19
 0  0      0 4358884  32672 1148528    0    0     0     0   56  396  0  0 100  0  0 2021-03-04 09:15:20
 0  0      0 4358900  32672 1148584    0    0     0     0   59  392  0  0 100  0  0 2021-03-04 09:15:21
 0  0      0 4358900  32672 1148584    0    0     0     0   47  361  0  0 100  0  0 2021-03-04 09:15:22
 0  0      0 4358900  32672 1148584    0    0     0     0   67  417  0  0 100  0  0 2021-03-04 09:15:23
 0  0      0 4358900  32672 1148584    0    0     0     0   71  439  0  0 100  0  0 2021-03-04 09:15:24
 0  0      0 4358900  32680 1148576    0    0     0    12   74  454  0  0 99  1  0 2021-03-04 09:15:25
 0  0      0 4358900  32680 1148576    0    0     0     0   63  410  0  0 100  0  0 2021-03-04 09:15:26
 0  0      0 4358900  32680 1148576    0    0     0     0   45  351  0  0 100  0  0 2021-03-04 09:15:27
 0  0      0 4358900  32680 1148576    0    0     0     0   66  409  0  0 100  0  0 2021-03-04 09:15:28
 0  0      0 4358900  32680 1148576    0    0     0     0   74  435  0  0 100  0  0 2021-03-04 09:15:29
 0  0      0 4358900  32680 1148576    0    0     0     0   34  242  0  0 100  0  0 2021-03-04 09:15:30
 0  0      0 4358900  32688 1148568    0    0     0    12  113  536  0  0 99  1  0 2021-03-04 09:15:31
 0  0      0 4358900  32688 1148568    0    0     0     0   47  359  0  0 100  0  0 2021-03-04 09:15:32
 0  0      0 4358900  32688 1148568    0    0     0     0   57  385  0  0 100  0  0 2021-03-04 09:15:33
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- -----timestamp-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st                 JST
 2  0      0 4358900  32688 1148568    0    0     0     0   61  400  0  0 100  0  0 2021-03-04 09:15:34
 0  0      0 4358900  32688 1148568    0    0     0     0   59  406  0  0 100  0  0 2021-03-04 09:15:35
 0  0      0 4358900  32688 1148568    0    0     0     0   53  374  0  0 100  0  0 2021-03-04 09:15:36
 0  0      0 4358900  32696 1148560    0    0     0    12   59  392  0  0 100  0  0 2021-03-04 09:15:37
 0  0      0 4358900  32696 1148560    0    0     0     0   57  397  0  0 100  0  0 2021-03-04 09:15:38
```

### 参考

- [プログラミングを学ぶ:【Linux】CPUとメモリの負荷と使用率をタイムスタンプ付きでログに残す](https://pg.echo-s.net/%E3%80%90linux%E3%80%91cpu%E3%81%A8%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AE%E8%B2%A0%E8%8D%B7%E3%81%A8%E4%BD%BF%E7%94%A8%E7%8E%87%E3%82%92%E3%82%BF%E3%82%A4%E3%83%A0%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%97/)
- [atmarkit:
【 vmstat 】コマンド――仮想メモリやディスクI/Oの統計情報を表示する](https://www.atmarkit.co.jp/ait/articles/1707/13/news015.html)
  - vmstatのオプションについて

## 標準出力/エラー出力を捨てる

標準出力

``` sh
${何らかのコマンド} 1> /dev/null
```

エラー出力

``` sh
${何らかのコマンド} 2> /dev/null
```

### 参考

- [Qiita:bashで標準出力、エラーを捨てるとか、ファイルディスクリプタ](https://qiita.com/harasakih/items/868a850fcdc99a2c37b0)
- [UNIX/Linuxの部屋 用語集:リダイレクト:用語集 リダイレクト コマンドの出力をファイルや別のコマンドに振り分ける (リダイレクション・パイプ) ](http://x68000.q-e-d.net/%7E68user/unix/pickup?%A5%EA%A5%C0%A5%A4%A5%EC%A5%AF%A5%C8)

## ログローテート

[logrotate.md](./logrotate.md)

## ダミーファイルを作成する(ddコマンド)

``` sh
dd if=/dev/zero of=${ファイルパス} bs=1${ファイルサイズ単位} count=${サイズ}
```

実行例

``` sh
dd if=/dev/zero of=15G.dummy bs=1G count=15
```

### 参考

- [Qiita:Linux で任意のサイズのファイルを作る](https://qiita.com/toshihirock/items/6cb99a85d86f524bc153)

## cat json - jq - lessを色付きにする

``` sh
cat ${任意のファイル} | jq '.' -C | less -R
```

## 改行コード確認

``` sh
od -c ${対象ファイル}
```

## 改行コード変換

``` sh
tr '変換元改行コード' '変換先改行コード' < 変換元ファイルパス > 変換先ファイルパス
```

## tab -> スペース変換(expand)

``` bash
expand -t ${スペースの個数} ${ファイルパス}
```

## diff

### 差分の行数を取得する

``` sh
diff ${ファイルパス1} ${ファイルパス2} | grep "^>" | wc -l
```

### 標準出力の結果の差分を取得する

``` sh
diff <(...) <(...)
```

``` sh
diff <(cat hoge.json | jq '.') <(cat piyo.json | jq '.')
```
みたいな感じで使う。

### タブ・スペース・開業の違いを無視する

| オプション | 意味 |
| :--------- | :--- |
| -E | タブとスペースの違いを無視するが・・・タブはスペース8個に換算される。 |
| -b | スペースの個数の違いを無視する。 |
| -w | スペースの違いを無視する。 | 
| -B | 空行を無視する。 |


#### 参考

- [diffで空白を無視する:適当なメモ](https://boscono.hatenablog.com/entry/20130126/p1)

## ファイルの行数を取得する(wc)

``` sh
cat ${ファイルパス} | wc -l
```

## 重複排除

``` sh
cat ${対象ファイル} | sort | uniq
```

## sshポートフォワーディング

``` sh
ssh -2 -N -f -L ${LOCAL_PORT}:${接続先ホスト名}:${接続先ポート番号} ${SSH2_USER}@${SSH2_HOST} -p ${SSH2_PORT}
```

** 使用終了時にプロセスをkillすること。**

## GUIとCUIを切り替える

### CUIにする

#### 一時的な変更

``` sh
systemctl isolate multi-user.target
```

#### 永続的な変更

``` sh
systemctl set-default multi-user.target
```

#### ログイン

Ctrl + Alt + F1 〜 F5

### GUIにする

#### 一時的な変更

``` sh
systemctl isolate graphical.target
```

#### 永続的な変更

``` sh
systemctl set-default graphical.target
```

## リモートデスクトップサービス

### インストール

``` sh
apt update && sudo apt upgrade -y
sudo apt install -y xrdp
```

### 起動設定

``` sh
sudo systemctl enable xrdp
sudo systemctl start xrdp
```

## 起動時に何らかのサービスを起動する

Ubuntuでは通常systemctlを使用するらしいが・・・

```sh
crontab -e
```

``` crontab
@reboot /etc/rc.local
```

``` sh
touch /etc/rc.local
nano /etc/rc.local
```

``` sh
# /etc/rc.localに起動したいサービスを書く
```

``` sh
chmod 755 /etc/rc.local
```

## ストレージのチェックと修復

``` bash
# ストレージの調査
sudo fdisk -l


# 不良セクタのチェック
sudo badblocks -v -s ${調査対象のストレージ} | tee /tmp/badblocks.txt

# 不良セクタのマーキング
e2fsck -l /tmp/badblocks.txt
```

### 参考

- [Linuxでディスクのエラーや不良セクタのチェックと修正をする方法 : Hack](https://kaworu.jpn.org/ubuntu/Linux%E3%81%A7%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE%E3%82%A8%E3%83%A9%E3%83%BC%E3%82%84%E4%B8%8D%E8%89%AF%E3%82%BB%E3%82%AF%E3%82%BF%E3%81%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%81%A8%E4%BF%AE%E6%AD%A3%E3%82%92%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)